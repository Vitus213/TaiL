# TaiL æ¶æ„æ˜ç¡®æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: TaiL - Window Time Tracker for Hyprland/Wayland  
**æ ¸å¿ƒç›®æ ‡**: ä¸º Hyprland/Wayland ç”¨æˆ·æä¾›è‡ªåŠ¨åŒ–çš„çª—å£ä½¿ç”¨æ—¶é—´è¿½è¸ªå’Œå¯è§†åŒ–ç»Ÿè®¡  
**æŠ€æœ¯æ ˆ**: Rust + Tokio + SQLite + egui  
**æ„å»ºç³»ç»Ÿ**: Nix Flakes (å¯å¤ç°æ„å»º)

---

## æ¶æ„è®¾è®¡åŸåˆ™

### 1. é«˜å†…èšä½è€¦åˆ
- æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œé€šè¿‡æ˜ç¡®çš„æ¥å£é€šä¿¡
- é¿å…å¾ªç¯ä¾èµ–ï¼Œä¾èµ–å…³ç³»å•å‘æµåŠ¨
- æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•å’Œæ›¿æ¢

### 2. åˆ†å±‚æ¶æ„
- **è¡¨ç°å±‚** (Presentation): GUI å±•ç¤º
- **ä¸šåŠ¡å±‚** (Business): ä¸šåŠ¡é€»è¾‘åè°ƒ
- **æ•°æ®å±‚** (Data): æ•°æ®æŒä¹…åŒ–
- **é›†æˆå±‚** (Integration): å¤–éƒ¨ç³»ç»Ÿé›†æˆ

### 3. äº‹ä»¶é©±åŠ¨
- åŸºäº Tokio å¼‚æ­¥è¿è¡Œæ—¶
- ä½¿ç”¨ channel è¿›è¡Œç»„ä»¶é—´é€šä¿¡
- å“åº”å¼å¤„ç†çª—å£äº‹ä»¶å’Œç”¨æˆ·è¾“å…¥

---

## æ¨¡å—æ¶æ„è¯¦è§£

### æ¨¡å—ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           tail-app (åº”ç”¨å…¥å£)                â”‚
â”‚- main.rs (GUI å¯åŠ¨)                      â”‚
â”‚    - service.rs (åå°æœåŠ¡å¯åŠ¨)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                 â”‚â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   tail-gui      â”‚            â”‚  tail-serviceâ”‚
â”‚   (è¡¨ç°å±‚)       â”‚            â”‚  (ä¸šåŠ¡åè°ƒå±‚)     â”‚
â”‚                 â”‚            â”‚                  â”‚
â”‚ - TaiLApp       â”‚            â”‚ - TailService    â”‚
â”‚ - Views         â”‚            â”‚ - äº‹ä»¶å¤„ç†        â”‚
â”‚ - Theme         â”‚            â”‚ - æ—¶é—´è®¡ç®—        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚    â”‚                â”‚
         â–¼    â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   tail-core     â”‚â—„â”€â”€â”€â”€â”€â”‚  tail-hyprland   â”‚
    â”‚   (æ•°æ®å±‚)       â”‚      â”‚  (é›†æˆå±‚)         â”‚
    â”‚                 â”‚      â”‚                  â”‚
    â”‚ - models.rs     â”‚      â”‚ - IPC å®¢æˆ·ç«¯      â”‚
    â”‚ - db.rs         â”‚      â”‚ - äº‹ä»¶è§£æ        â”‚
    â”‚ - Repository    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   tail-afk       â”‚
    â”‚   (é›†æˆå±‚)        â”‚
    â”‚                  â”‚
    â”‚ - AfkDetector    â”‚
    â”‚ -ç©ºé—²æ£€æµ‹        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—èŒè´£çŸ©é˜µ

| æ¨¡å— | èŒè´£ | ä¸»è¦ç»„ä»¶ | ä¾èµ– |
|------|------|----------|------|
| **tail-app** | åº”ç”¨å…¥å£ç‚¹ | main.rs, service.rs | tail-gui, tail-service |
| **tail-gui** | ç”¨æˆ·ç•Œé¢å±•ç¤º | TaiLApp, Views, Theme | tail-core, egui |
| **tail-service** | ä¸šåŠ¡é€»è¾‘åè°ƒ | TailService, äº‹ä»¶å¤„ç† | tail-core, tail-hyprland, tail-afk |
| **tail-core** | æ•°æ®æ¨¡å‹ä¸æŒä¹…åŒ– | WindowEvent, Repository | rusqlite, r2d2 |
| **tail-hyprland** | Hyprland é›†æˆ | HyprlandIpc, Eventè§£æ | tokio |
| **tail-afk** | ç©ºé—²æ£€æµ‹ | AfkDetector | - |

---

## æ ¸å¿ƒæ•°æ®æµ

### 1. çª—å£è¿½è¸ªæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hyprland   â”‚ (Unix Socket .socket2.sock)
â”‚   çª—å£ç®¡ç†å™¨â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ IPC Events
       â”‚ (activewindow, openwindow, etc.)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-hyprland    â”‚
â”‚ HyprlandIpc      â”‚
â”‚ - è¿æ¥ socketâ”‚
â”‚ - è§£æäº‹ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HyprlandEvent
       â”‚ (ActiveWindowChanged, etc.)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-service     â”‚
â”‚ - æ¥æ”¶äº‹ä»¶       â”‚
â”‚ - è®¡ç®—æ—¶é•¿â”‚
â”‚ - æ£€æŸ¥ AFK       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WindowEvent
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-core        â”‚
â”‚ Repositoryâ”‚
â”‚ - å†™å…¥ SQLite    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æŸ¥è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-gui         â”‚
â”‚ - ç”¨æˆ·è¯·æ±‚ç»Ÿè®¡   â”‚
â”‚ - é€‰æ‹©æ—¶é—´èŒƒå›´   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Query Requestâ–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-coreâ”‚
â”‚ Repository       â”‚
â”‚ - get_app_usage()â”‚
â”‚ - get_window_events()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ SQL Query
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite Database  â”‚
â”‚ - window_events  â”‚
â”‚ - afk_events     â”‚
â”‚ - daily_goals    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Result Set
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tail-gui         â”‚
â”‚ - æ¸²æŸ“å›¾è¡¨       â”‚
â”‚ - æ˜¾ç¤ºç»Ÿè®¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“

#### WindowEvent (çª—å£äº‹ä»¶)
```rust
pub struct WindowEvent {
    pub id: Option<i64>,           // æ•°æ®åº“ ID
    pub timestamp: DateTime<Utc>,  // äº‹ä»¶å‘ç”Ÿæ—¶é—´
    pub app_name: String,          // åº”ç”¨ç±»å (å¦‚ "firefox")
    pub window_title: String,      // çª—å£æ ‡é¢˜
    pub workspace: String,         // Hyprland å·¥ä½œåŒº
    pub duration_secs: i64,        // çª—å£ä½¿ç”¨æ—¶é•¿(ç§’)
    pub is_afk: bool,              // æœŸé—´æ˜¯å¦ç©ºé—²
}
```

**ç”¨é€”**: è®°å½•æ¯æ¬¡çª—å£åˆ‡æ¢çš„è¯¦ç»†ä¿¡æ¯å’Œä½¿ç”¨æ—¶é•¿

#### AfkEvent (ç©ºé—²äº‹ä»¶)
```rust
pub struct AfkEvent {
    pub id: Option<i64>,                // æ•°æ®åº“ ID
    pub start_time: DateTime<Utc>,       // ç©ºé—²å¼€å§‹æ—¶é—´
    pub end_time: Option<DateTime<Utc>>, // ç©ºé—²ç»“æŸæ—¶é—´ (å¯ä¸ºnull)
    pub duration_secs: i64,              // ç©ºé—²æŒç»­æ—¶é•¿(ç§’)
}
```

**ç”¨é€”**: è¿½è¸ªç”¨æˆ·ç¦»å¼€è®¡ç®—æœºçš„æ—¶æ®µï¼Œç”¨äºè¿‡æ»¤éæ´»è·ƒæ—¶é—´

#### DailyGoal (æ¯æ—¥ç›®æ ‡)
```rust
pub struct DailyGoal {
    pub id: Option<i64>,        // æ•°æ®åº“ ID
    pub app_name: String,       // åº”ç”¨åç§° (å”¯ä¸€)
    pub max_minutes: i32,       // æœ€å¤§å…è®¸ä½¿ç”¨åˆ†é’Ÿæ•°
    pub notify_enabled: bool,   // æ˜¯å¦å¯ç”¨é€šçŸ¥
}
```

**ç”¨é€”**: è®¾ç½®åº”ç”¨ä½¿ç”¨æ—¶é•¿é™åˆ¶ï¼Œè¶…å‡ºæ—¶å‘é€é€šçŸ¥

#### AppUsage (åº”ç”¨ä½¿ç”¨ç»Ÿè®¡)
```rust
pub struct AppUsage {
    pub app_name: String,              // åº”ç”¨åç§°
    pub total_seconds: i64,            // æ€»ä½¿ç”¨ç§’æ•°
    pub window_events: Vec<WindowEvent>, // è¯¦ç»†äº‹ä»¶åˆ—è¡¨
}
```

**ç”¨é€”**: èšåˆç»Ÿè®¡æŸåº”ç”¨åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ€»ä½¿ç”¨æ—¶é•¿

---

## æ•°æ®åº“ Schema

### window_events è¡¨
```sql
CREATE TABLE window_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME NOT NULL,        -- ç´¢å¼•
    app_name TEXT NOT NULL,             -- ç´¢å¼•
    window_title TEXT,
    workspace TEXT,
    duration_secs INTEGER NOT NULL DEFAULT 0,
    is_afk BOOLEAN NOT NULL DEFAULT 0
);

CREATE INDEX idx_window_events_timestamp ON window_events(timestamp);
CREATE INDEX idx_window_events_app ON window_events(app_name);
```

### afk_events è¡¨
```sql
CREATE TABLE afk_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    start_time DATETIME NOT NULL,
    end_time DATETIME,
    duration_secs INTEGER NOT NULL DEFAULT 0
);
```

### daily_goals è¡¨
```sql
CREATE TABLE daily_goals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    app_name TEXT NOT NULL UNIQUE,
    max_minutes INTEGER NOT NULL,
    notify_enabled BOOLEAN NOT NULL DEFAULT 1
);
```

**å­˜å‚¨ä½ç½®**: `~/.local/share/tail/tail.db` (éµå¾ª XDG Base Directory è§„èŒƒ)

---

## å¹¶å‘æ¨¡å‹

### æœåŠ¡ç«¯å¼‚æ­¥æ¶æ„

```rust
Tokio Runtime (å¼‚æ­¥è¿è¡Œæ—¶)
    â”‚
    â”œâ”€â”€â”€ Task1: Hyprland IPC è®¢é˜…
    â”‚    â””â”€ UnixStream::connect()
    â”‚       â””â”€ BufReader::read_line() (å¼‚æ­¥é˜»å¡)
    â”‚          â””â”€ mpsc::Sender::send(HyprlandEvent)
    â”‚
    â”œâ”€â”€â”€ Task 2: äº‹ä»¶å¤„ç†å¾ªç¯
    â”‚    â””â”€ mpsc::Receiver::recv()
    â”‚       â”œâ”€ è®¡ç®—çª—å£ä½¿ç”¨æ—¶é•¿
    â”‚       â”œâ”€ æŸ¥è¯¢ AFK çŠ¶æ€
    â”‚       â””â”€ Repository::insert_window_event()
    â”‚
    â””â”€â”€â”€ Task 3: AFK æ£€æµ‹ (å¯é€‰)
         â””â”€ å®šæœŸæ£€æŸ¥ç”¨æˆ·æ´»åŠ¨
            â””â”€ æ›´æ–° AFK çŠ¶æ€
```

### GUI åŒæ­¥æ¨¡å‹

```rust
eframe::App (å•çº¿ç¨‹ UI)
    â”‚
    â”œâ”€â”€â”€ update() æ¯å¸§è°ƒç”¨
    â”‚    â”œâ”€ å¤„ç†ç”¨æˆ·è¾“å…¥
    â”‚    â”œâ”€ æŸ¥è¯¢æ•°æ® (åŒæ­¥è°ƒç”¨ Repository)
    â”‚    â””â”€ æ¸²æŸ“ UI ç»„ä»¶
    â”‚
    â””â”€â”€â”€ æ•°æ®ç¼“å­˜ç­–ç•¥
         â””â”€ é¿å…æ¯å¸§æŸ¥è¯¢æ•°æ®åº“
```

---

## Hyprland é›†æˆè¯¦è§£

### Socket é€šä¿¡

**Socket è·¯å¾„**: `$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock`

**è¿æ¥æ–¹å¼**: Unix Domain Socket (å¼‚æ­¥è¯»å–)

### æ”¯æŒçš„äº‹ä»¶ç±»å‹

| äº‹ä»¶å| æ ¼å¼ | ç¤ºä¾‹ | å¤„ç†é€»è¾‘ |
|--------|------|------|----------|
| `activewindow` | `CLASS,TITLE` | `firefox,GitHub - Mozilla Firefox` | è®°å½•çª—å£åˆ‡æ¢ï¼Œè®¡ç®—ä¸Šä¸€çª—å£æ—¶é•¿ |
| `openwindow` | `ADDR,WS,CLASS,TITLE` | `0x12345,1,kitty,Terminal` | æ–°çª—å£æ‰“å¼€ |
| `closewindow` | `ADDR` | `0x12345` |çª—å£å…³é—­ |
| `workspace` | `NAME` | `2` | å·¥ä½œåŒºåˆ‡æ¢ |
| `windowtitlev2` | `ADDR,TITLE` | `0x12345,New Title` | çª—å£æ ‡é¢˜å˜åŒ– |

### äº‹ä»¶è§£æé€»è¾‘

```rust
// åŸå§‹äº‹ä»¶æ ¼å¼: "EVENT>>DATA"
"activewindow>>firefox,GitHub - Mozilla Firefox"

// è§£æå:
HyprlandEvent::ActiveWindowChanged {
    class: "firefox",
    title: "GitHub - Mozilla Firefox"
}
```

---

## é”™è¯¯å¤„ç†ç­–ç•¥

### é”™è¯¯ç±»å‹å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       åº”ç”¨å±‚é”™è¯¯ (anyhow)            â”‚
â”‚  - ä¸Šä¸‹æ–‡ä¸°å¯Œçš„é”™è¯¯ä¿¡æ¯              â”‚
â”‚  - é€‚åˆä¸šåŠ¡é€»è¾‘é”™è¯¯ä¼ æ’­              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   DbError   â”‚  â”‚  IpcError   â”‚
â”‚ (thiserror) â”‚  â”‚ (thiserror) â”‚
â”‚â”‚  â”‚             â”‚
â”‚ - Sqlite    â”‚  â”‚ - Socket    â”‚
â”‚ - Pool      â”‚  â”‚   NotFound  â”‚
â”‚ - NotFound  â”‚  â”‚ - Invalid   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚Event     â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯ä¼ æ’­è§„åˆ™

1. **åº•å±‚æ¨¡å—** (`tail-core`, `tail-hyprland`, `tail-afk`):
   - ä½¿ç”¨ `thiserror` å®šä¹‰ä¸“ç”¨é”™è¯¯ç±»å‹
   - é”™è¯¯ç±»å‹æ˜ç¡®ï¼Œä¾¿äºä¸Šå±‚å¤„ç†

2. **ä¸šåŠ¡å±‚** (`tail-service`):
   - ä½¿ç”¨ `anyhow::Result` è¿›è¡Œé”™è¯¯ä¸Šä¸‹æ–‡æ·»åŠ 
   - è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

3. **è¡¨ç°å±‚** (`tail-gui`):
   - æ•è·æ‰€æœ‰é”™è¯¯
   - è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### æ•°æ®åº“ä¼˜åŒ–

1. **è¿æ¥æ± **: ä½¿ç”¨ `r2d2` é¿å…é¢‘ç¹å»ºç«‹è¿æ¥
   - æœ€å¤§è¿æ¥æ•°: 10
   - å¤ç”¨è¿æ¥å‡å°‘å¼€é”€

2. **ç´¢å¼•ç­–ç•¥**:
   - `timestamp` å­—æ®µç´¢å¼• - åŠ é€Ÿæ—¶é—´èŒƒå›´æŸ¥è¯¢
   - `app_name` å­—æ®µç´¢å¼• - åŠ é€Ÿåº”ç”¨ç»Ÿè®¡

3. **æ‰¹é‡å†™å…¥**:
   - ä½¿ç”¨äº‹åŠ¡åˆå¹¶å¤šæ¬¡å†™å…¥
   - å‡å°‘ç£ç›˜ I/O

### å†…å­˜ä¼˜åŒ–

1. **äº‹ä»¶ç¼“å†²**: ä½¿ç”¨æœ‰ç•Œ channel (å®¹é‡ 100)
   - é˜²æ­¢äº‹ä»¶ç§¯å‹å¯¼è‡´å†…å­˜æº¢å‡º
   - èƒŒå‹æœºåˆ¶ä¿æŠ¤ç³»ç»Ÿ

2. **åˆ†é¡µåŠ è½½**: GUI å†å²æ•°æ®åˆ†é¡µæ˜¾ç¤º
   - é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
   - æŒ‰éœ€åŠ è½½æå‡å“åº”é€Ÿåº¦

### å»¶è¿Ÿä¼˜åŒ–

1. **å¼‚æ­¥å¤„ç†**: æ•°æ®åº“å†™å…¥å¼‚æ­¥åŒ–- ä¸é˜»å¡äº‹ä»¶å¤„ç†å¾ªç¯
   - æé«˜ç³»ç»Ÿååé‡

2. **UI åˆ†ç¦»**: æ¸²æŸ“ä¸æ•°æ®è·å–åˆ†ç¦»
   - ä½¿ç”¨ç¼“å­˜é¿å…æ¯å¸§æŸ¥è¯¢
   - åå°æ›´æ–°æ•°æ®

---

## æ‰©å±•ç‚¹è®¾è®¡

### 1. æ–°å¢çª—å£ç®¡ç†å™¨æ”¯æŒ

**ç¤ºä¾‹**: åˆ›å»º `tail-sway` æ¨¡å—æ”¯æŒ Sway

```
tail-sway/
â”œâ”€â”€ Cargo.toml
â””â”€â”€ src/
    â”œâ”€â”€ lib.rs
    â””â”€â”€ ipc.rs  // å®ç°ç±»ä¼¼ HyprlandIpc çš„æ¥å£

// ç»Ÿä¸€çš„äº‹ä»¶æ¥å£
pub trait WindowManagerIpc {
    fn subscribe_events<F>(&self, callback: F) -> Result<()>
    where F: FnMut(WindowEvent);
}
```

### 2. æ–°å¢ GUI æ¡†æ¶

**ç¤ºä¾‹**: åˆ›å»º `tail-tauri` ä½¿ç”¨ Web æŠ€æœ¯æ ˆ

```
tail-tauri/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src-tauri/
â”‚   â””â”€â”€ main.rs  // è°ƒç”¨ tail-core
â””â”€â”€ src/
    â””â”€â”€ App.tsx  // React å‰ç«¯
```

**ä¼˜åŠ¿**: `tail-core` å®Œå…¨ç‹¬ç«‹äº GUIï¼Œæ˜“äºæ›¿æ¢

### 3. æ–°å¢æ•°æ®æº

**ç¤ºä¾‹**: æ‰©å±• AFK æ£€æµ‹æ”¯æŒå¤šç§è¾“å…¥è®¾å¤‡

```rust
pub trait ActivityDetector {
    fn check_activity(&self) -> bool;
}

impl ActivityDetector for KeyboardDetector { ... }
impl ActivityDetector for MouseDetector { ... }
impl ActivityDetector for WaylandIdleDetector { ... }
```

---

## å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®ç°

- [x] åŸºç¡€é¡¹ç›®ç»“æ„ (Workspace + Modules)
- [x] æ•°æ®æ¨¡å‹å®šä¹‰ (`WindowEvent`, `AfkEvent`, `DailyGoal`)
- [x] æ•°æ®åº“ Schemaå’ŒRepository
- [x] Hyprland IPC å®¢æˆ·ç«¯å’Œäº‹ä»¶è§£æ
- [x] åŸºç¡€ GUI æ¡†æ¶ (egui)
- [x] ä¸»é¢˜ç³»ç»Ÿ (Auto/Light/Dark)
- [x] Nix Flakes æ„å»ºé…ç½®

### ğŸš§ éƒ¨åˆ†å®ç°

- [ ] äº‹ä»¶å¤„ç†é€»è¾‘ (ä»…è®°å½•æ—¥å¿—ï¼Œæœªè®¡ç®—æ—¶é•¿)
- [ ] AFK æ£€æµ‹ (æ¨¡å—å­˜åœ¨ä½†æœªé›†æˆ)
- [ ] GUI è§†å›¾ (åŸºç¡€æ¡†æ¶ï¼Œç¼ºå°‘å›¾è¡¨å’Œç»Ÿè®¡)

### âŒ å¾…å®ç°

- [ ] çª—å£æ—¶é•¿è®¡ç®—é€»è¾‘
- [ ] AFK çŠ¶æ€ä¸çª—å£äº‹ä»¶çš„é›†æˆ
- [ ] å®Œæ•´çš„æ•°æ®æŸ¥è¯¢ API
- [ ] GUIä»ªè¡¨æ¿å’Œå›¾è¡¨
- [ ] ç›®æ ‡é™åˆ¶å’Œé€šçŸ¥ç³»ç»Ÿ
- [ ] æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] ç³»ç»Ÿæ‰˜ç›˜é›†æˆ
- [ ] è‡ªåŠ¨å¯åŠ¨é…ç½®

---

## æ¶æ„ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è®¾è®¡
- æ¸…æ™°çš„èŒè´£åˆ’åˆ†
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒç‹¬ç«‹æ¼”è¿›

### 2. æŠ€æœ¯é€‰å‹åˆç†
- **Rust**: å†…å­˜å®‰å…¨ã€é«˜æ€§èƒ½
- **Tokio**: æˆç†Ÿçš„å¼‚æ­¥è¿è¡Œæ—¶
- **SQLite**:åµŒå…¥å¼æ•°æ®åº“ï¼Œé›¶é…ç½®
- **egui**: åŸç”Ÿ GUIï¼Œè·¨å¹³å°

### 3. å¯æ‰©å±•æ€§å¼º
- æ”¯æŒå¤šçª—å£ç®¡ç†å™¨
- æ”¯æŒå¤šGUI æ¡†æ¶
- æ’ä»¶åŒ–è®¾è®¡

### 4. å¯ç»´æŠ¤æ€§å¥½
- ä½¿ç”¨ Nix ä¿è¯æ„å»ºä¸€è‡´æ€§
- å®Œå–„çš„æ–‡æ¡£
- æ¸…æ™°çš„é”™è¯¯å¤„ç†

---

## æ¶æ„æ”¹è¿›å»ºè®®

### 1. å®Œå–„çŠ¶æ€ç®¡ç†

**é—®é¢˜**: `TailService` ä¸­çŠ¶æ€ç®¡ç†ä¸å®Œæ•´

**å»ºè®®**:
```rust
pub struct TailService {
    repo: Repository,
    current_window: Option<ActiveWindow>,
    last_switch_time: Option<Instant>,
    afk_detector: AfkDetector,
}

struct ActiveWindow {
    app_name: String,
    title: String,
    workspace: String,
    start_time: Instant,
}
```

### 2. å¢åŠ é…ç½®ç³»ç»Ÿ

**å»ºè®®**: ä½¿ç”¨ `config` crate ç®¡ç†é…ç½®

```toml
# ~/.config/tail/config.toml
[database]
path = "~/.local/share/tail/tail.db"

[afk]
timeout_seconds = 300# 5 åˆ†é’Ÿæ— æ´»åŠ¨å³AFK

[gui]
theme = "auto"  # auto/light/dark
refresh_interval_ms = 1000
```

### 3. æ·»åŠ æ—¥å¿—è½®è½¬

**å»ºè®®**: ä½¿ç”¨ `tracing-appender` è¿›è¡Œæ—¥å¿—è½®è½¬

```rust
use tracing_appender::rolling::{RollingFileAppender, Rotation};

let file_appender = RollingFileAppender::new(Rotation::DAILY,
    "~/.local/share/tail/logs",
    "tail.log"
);
```

### 4. å®ç° GUI-Service é€šä¿¡

**å»ºè®®**: ä½¿ç”¨ Unix Socket æˆ– IPC

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Unix Socket        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tail-gui   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ tail-service â”‚
â”‚  (è¿›ç¨‹ A)   â”‚   Request/Response Protocolâ”‚(è¿›ç¨‹ B)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. å¢åŠ æ•°æ®éªŒè¯

**å»ºè®®**: åœ¨`Repository` å±‚æ·»åŠ æ•°æ®éªŒè¯

```rust
impl Repository {
    pub fn insert_window_event(&self, event: &WindowEvent) -> Result<i64, DbError> {
        // éªŒè¯
        if event.duration_secs < 0 {
            return Err(DbError::InvalidData("duration cannot be negative"));
        }
        
        // æ’å…¥...
    }
}
```

---

## æ¶æ„å›¾è¡¨æ€»ç»“

### æ•´ä½“æ¶æ„è§†å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TaiL ç³»ç»Ÿæ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  è¡¨ç°å±‚ (Presentation)                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚  â”‚  tail-gui    â”‚              â”‚  tail-app    â”‚         â”‚  â”‚
â”‚  â”‚  â”‚  (egui UI)   â”‚              â”‚  (å…¥å£ç‚¹)    â”‚         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  ä¸šåŠ¡å±‚ (Business)                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  tail-service (åå°æœåŠ¡)                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - äº‹ä»¶åè°ƒ                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - æ—¶é—´è®¡ç®—                                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - ä¸šåŠ¡é€»è¾‘                                        â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   æ•°æ®å±‚ (Data)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  tail-core (æ•°æ®æ¨¡å‹ + æŒä¹…åŒ–)                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - WindowEvent, AfkEvent, DailyGoal               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Repository (æ•°æ®åº“è®¿é—®)                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - SQLite (window_events, afk_events,...)       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 é›†æˆå±‚ (Integration)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ tail-hyprland    â”‚      â”‚  tail-afk                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (Hyprland IPC)   â”‚      â”‚  (AFK æ£€æµ‹å™¨)            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç»“è®º

TaiL é¡¹ç›®é‡‡ç”¨äº†**æ¸…æ™°çš„åˆ†å±‚æ¶æ„**å’Œ**æ¨¡å—åŒ–è®¾è®¡**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:

1. **èŒè´£æ˜ç¡®**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ¸…æ™°çš„èŒè´£è¾¹ç•Œ
2. **ä¾èµ–åˆç†**: å•å‘ä¾èµ–æµï¼Œé¿å…å¾ªç¯ä¾èµ–
3. **æŠ€æœ¯æˆç†Ÿ**: é€‰ç”¨ Rust ç”Ÿæ€ä¸­æˆç†Ÿç¨³å®šçš„åº“
4. **æ˜“äºæ‰©å±•**: é€šè¿‡æ¥å£æŠ½è±¡æ”¯æŒå¤šç§å®ç°
5. **æ€§èƒ½ä¼˜è‰¯**: å¼‚æ­¥æ¶æ„ + æ•°æ®åº“ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: æ ¸å¿ƒæ¶æ„å·²æ­å»ºå®Œæˆï¼Œéœ€è¦è¡¥å……ä¸šåŠ¡é€»è¾‘å®ç°

**åç»­é‡ç‚¹**:
- å®Œå–„äº‹ä»¶å¤„ç†å’Œæ—¶é•¿è®¡ç®—
- å®ç° GUI æ•°æ®å±•ç¤ºå’Œå›¾è¡¨
- æ·»åŠ é…ç½®ç³»ç»Ÿå’Œé€šçŸ¥åŠŸèƒ½
- ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

è¯¥æ¶æ„ä¸ºé¡¹ç›®çš„é•¿æœŸæ¼”è¿›æä¾›äº†åšå®çš„åŸºç¡€ã€‚